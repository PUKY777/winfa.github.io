<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <td><button><a href="../index.html">Winfa</a></button></td>
    
    <title>Tu Mapa</title>

    <style>
        #map {
            height: 700px;
        }

        .nueva-tabla, .social-table {
            width: 100%;
            margin-top: 5px;
            border-collapse: collapse;
        }

        .nueva-tabla td, .social-table td {
            padding: 5px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .nueva-tabla img, .social-table img {
            width: 30px;
            height: auto;
            margin: 0;
        }

        .horario-dropdown, .compartir-dropdown {
            display: none;
            margin-top: 0;
            margin-bottom: 0;
        }

        .horario-button, .horario-toggle, .compartir-button, .compartir-toggle {
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 12px;
            margin: 2px 2px;
            transition-duration: 0.4s;
            border-radius: 3px;
        }

        .horario-button, .compartir-button {
            background-color: #007BFF;
        }
    </style>

    <!-- Agrega Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body>

    <!-- Contenido principal de tu página -->
    <div id="map"></div>

    <!-- Agrega Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var map = L.map('map');
            var userMarker;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var userLocation = [position.coords.latitude, position.coords.longitude];

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);

                    userMarker = L.marker(userLocation, {
                            draggable: true
                        })
                        .addTo(map)
                        .bindPopup("Tu ubicación actual")
                        .openPopup();

                    var grupos = {
                        Agricultura: L.layerGroup(),
                        Manufactura: L.layerGroup(),
                        Servicios: L.layerGroup()
                    };

                    var marcadores = {
                        Agricultura: [],
                        Manufactura: [],
                        Servicios: [{
                            latitud: -19.053839,
                            longitud: -65.253089,
                            sigla: "Calle de los gatos",
                            nombre: "",
                            horario: {
                                Lunes: "00:00 - 24:00",
                                Martes: "00:00 - 24:00",
                                Miércoles: "00:00 - 24:00",
                                Jueves: "00:00 - 24:00",
                                Viernes: "00:00 - 24:00",
                                Sabado: "00:00 - 24:00",
                                Domingo: "00:00 - 24:00"
                            },
                            direccion: "Calle: Gato Negro",
                            origen: "Sucre - Chuquisaca - Bolivia",
                            facebook: null,
                            whatsapp: null,
                            tiktok: null,
                            sitioWeb: null,
                            correo: null,
                            videopresentacion: "https://vm.tiktok.com/ZM6QXV1nS/",
                            ecommerce: null,
                            promocion: null,
                            transporte: null,
                            foto: "Edificios/calle de los gatos.jpg"
                        }]
                        // Agrega más marcadores según sea necesario
                    };

                    Object.keys(grupos).forEach(grupo => {
                        marcadores[grupo].forEach(marcador => {
                            var socialTableContent = generateSocialTableContent(marcador);
                            var nuevaTablaContent = generateNuevaTablaContent(marcador);
                            var horarioDropdownContent = generateHorarioDropdownContent(marcador);

                            var popupContent = `
                                <div style="max-width: 300px;">
                                    <h3 style="margin: 0;">${marcador.sigla}</h3>
                                    <p style="margin: 5px 0 0;">${marcador.nombre}</p>
                                    <div class="horario-toggle" onclick="toggleHorario(this)">Horario</div>
                                    ${horarioDropdownContent}
                                    <p style="margin: 0;"><strong>Dirección:</strong> ${marcador.direccion}</p>
                                    <p style="margin: 0;"><strong>Origen:</strong> ${marcador.origen}</p>
                                    ${nuevaTablaContent} <!-- Tabla de información -->
                                    <img src="${marcador.foto}" alt="Foto del marcador" style="width: 100%; max-width: 200px; margin-top: 5px;">
                                    ${socialTableContent} <!-- Tabla de redes sociales -->
                                    <div class="compartir-toggle" onclick="toggleCompartir(this, '${marcador.sigla}', ${marcador.latitud}, ${marcador.longitud})">Compartir Enlace</div>
                                    <div class="compartir-dropdown" id="compartir-${marcador.sigla}"></div>
                                </div>
                            `;

                            var marcadorLayer = L.marker([marcador.latitud, marcador.longitud], {
                                title: marcador.sigla
                            }).bindPopup(popupContent);

                            grupos[grupo].addLayer(marcadorLayer);
                        });
                    });

                    Object.keys(grupos).forEach(grupo => {
                        map.addLayer(grupos[grupo]);
                    });

                    L.control.layers(null, grupos, {
                        collapsed: false
                    }).addTo(map);

                    map.setView(userLocation, 16);

                    userMarker.on('drag', function (event) {
                        actualizarDistancias();
                    });

                    function actualizarDistancias() {
                        Object.keys(grupos).forEach(grupo => {
                            grupos[grupo].eachLayer(function (m) {
                                var distancia = userMarker.getLatLng().distanceTo(m.getLatLng());
                                document.getElementById('distancia-' + m.options.title).innerText = `Distancia: ${distancia.toFixed(2)} metros`;
                            });
                        });
                    }

                    function generateSocialTableContent(marcador) {
                        var socialTableContent = `<table class="social-table"><tr>`;
                        if (marcador.facebook) {
                            socialTableContent += `<td><a href="${marcador.facebook}" target="_blank"><img src="facebook.png" alt="Facebook"></a></td>`;
                        }
                        if (marcador.whatsapp) {
                            socialTableContent += `<td><a href="${marcador.whatsapp}" target="_blank"><img src="whatsapp.png" alt="WhatsApp"></a></td>`;
                        }
                        if (marcador.tiktok) {
                            socialTableContent += `<td><a href="${marcador.tiktok}" target="_blank"><img src="tiktok.png" alt="TikTok"></a></td>`;
                        }
                        if (marcador.sitioWeb) {
                            socialTableContent += `<td><a href="${marcador.sitioWeb}" target="_blank"><img src="pagina.png" alt="Sitio Web"></a></td>`;
                        }
                        if (marcador.correo) {
                            socialTableContent += `<td><a href="${marcador.correo}" target="_blank"><img src="correo.jpg" alt="Correo"></a></td>`;
                        }
                        socialTableContent += `</tr></table>`;
                        return socialTableContent;
                    }

                    function generateNuevaTablaContent(marcador) {
                        var nuevaTablaContent = `<table class="nueva-tabla"><tr>`;
                        if (marcador.videopresentacion) {
                            nuevaTablaContent += `<td><a href="${marcador.videopresentacion}" target="_blank"><img src="videopresentacion.png" alt="Videopresentacion"></a></td>`;
                        }
                        if (marcador.transporte) {
                            nuevaTablaContent += `<td><a href="${marcador.transporte}" target="_blank"><img src="transporte.png" alt="Transporte"></a></td>`;
                        }
                        if (marcador.ecommerce) {
                            nuevaTablaContent += `<td><a href="${marcador.ecommerce}" target="_blank"><img src="ecommerce.png" alt="Ecommerce"></a></td>`;
                        }
                        if (marcador.promocion) {
                            nuevaTablaContent += `<td><a href="${marcador.promocion}" target="_blank"><img src="promocion.png" alt="Promoción"></a></td>`;
                        }
                        nuevaTablaContent += `</tr></table>`;
                        return nuevaTablaContent;
                    }

                    function generateHorarioDropdownContent(marcador) {
                        var horarioDropdownContent = '<div class="horario-dropdown">';
                        Object.keys(marcador.horario).forEach(dia => {
                            horarioDropdownContent += `<button class="horario-button">${dia}: ${marcador.horario[dia]}</button>`;
                        });
                        horarioDropdownContent += '</div>';
                        return horarioDropdownContent;
                    }

                });
            } else {
                map.setView([0, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
            }
        });

        function compartirEnRed(red, sigla, latitud, longitud) {
            var paginaActual = window.location.origin + window.location.pathname;
            var enlaceMarcador = paginaActual + '?marker=' + sigla + '&lat=' + latitud + '&lng=' + longitud;

            switch (red) {
                case 'whatsapp':
                    window.open('https://api.whatsapp.com/send?text=' + encodeURIComponent(enlaceMarcador), '_blank');
                    break;
                // Agrega más casos según sea necesario
                default:
                    break;
            }
        }

        function toggleHorario(element) {
            var horarioDropdown = element.nextElementSibling;
            horarioDropdown.style.display = horarioDropdown.style.display === 'none' ? 'block' : 'none';
        }

        function toggleCompartir(element, sigla, latitud, longitud) {
            var compartirDropdown = document.getElementById('compartir-' + sigla);
            compartirDropdown.innerHTML = `
                <button class="compartir-button" onclick="compartirEnRed('whatsapp', '${sigla}', ${latitud}, ${longitud})">WhatsApp</button>
                <!-- Agrega más botones según sea necesario -->
            `;
            compartirDropdown.style.display = compartirDropdown.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</body>

</html>
