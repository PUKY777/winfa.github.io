<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Mapa</title>
    <style>
    #map-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh; /* Utiliza el 100% del alto de la ventana */
    z-index: 1;
    }

    #map {
        width: 100%;
        height: 100%;
    }

    #ubicacion-actual-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1;
    }

    #group-filters {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1;
        background-color: white;
        padding: 10px;
        border-radius: 5px;
    }

    .group-filter {
        display: inline-block;
        margin-right: 10px;
    }

    .nueva-tabla {
        margin-top: 10px;
    }

    .social-table img,
    .nueva-tabla img {
        width: 20px;
        height: 20px;
    }

    .horario-dropdown {
        display: none;
        background-color: white; /* Texto blanco */
        padding: 5px;
        border-radius: 1px;
    }

    .horario-button {
        display: block;
        width: 100%;
        padding: 5px;
        text-align: left;
        background-color: white; /* Texto blanco */
        border: none;
        cursor: pointer;
        color: black;
    }

    .horario-toggle {
        background-color: green; /* Fondo verde */
        padding: 5px 10px;
        color: white; /* Texto blanco */
        border-radius: 5px;
        cursor: pointer;
        display: inline-block;
    }

    #compartirBtn {
        background-color: blue; /* Fondo azul */
        color: white; /* Texto blanco */
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 5px;
    }
</style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAgrRITrhfXPI_-pj4PVvyQ9_7AZn1cpHE&callback=initMap"
        defer></script>
    <script>
        var map;
        var grupos = {
            Agricultura: [],
            Manufactura: [],
            Servicios: []
        };

        var marcadores = {
            Agricultura: [],
            Manufactura: [],
            Servicios: [{
                latitud: -19.053839,
                longitud: -65.253089,
                sigla: "Calle de los gatos",
                nombre: "",
                horario: {
                    Lunes: "00:00 - 24:00",
                    Martes: "00:00 - 24:00",
                    Miércoles: "00:00 - 24:00",
                    Jueves: "00:00 - 24:00",
                    Viernes: "00:00 - 24:00",
                    Sábado: "00:00 - 24:00",
                    Domingo: "00:00 - 24:00"
                },
                direccion: "Calle: Gato Negro",
                origen: "Sucre - Chuquisaca - Bolivia",
                facebook: null,
                whatsapp: null,
                tiktok: null,
                sitioWeb: null,
                correo: null,
                videopresentacion: "https://vm.tiktok.com/ZM6QXV1nS/",
                ecommerce: null,
                promocion: null,
                transporte: null,
                foto: "Edificios/CalleDeLosGatos.jpg"
            }]
        };

        var ubicacionActualMarker;

        function initMap() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var ubicacion = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map = new google.maps.Map(document.getElementById('map'), {
                        center: ubicacion,
                        zoom: 19,
                        mapTypeControlOptions: {
                            mapTypeIds: ['satellite', 'hybrid', 'terrain', 'roadmap'],
                            style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
                        },
                        mapTypeId: 'satellite',
                        streetViewControl: false,
                        fullscreenControl: false,
                        zoomControl: true,
                        styles: [{
                            "featureType": "poi",
                            "stylers": [{ "visibility": "off" }]
                        }, {
                            "featureType": "road",
                            "stylers": [{ "visibility": "off" }]
                        }, {
                            "featureType": "transit",
                            "stylers": [{ "visibility": "off" }]
                        }, {
                            "featureType": "administrative",
                            "elementType": "geometry.stroke",
                            "stylers": [{ "visibility": "off" }]
                        }]
                    });

                    // Agregar marcador de ubicación actual
                    ubicacionActualMarker = new google.maps.Marker({
                        position: ubicacion,
                        map: map,
                        title: 'Tu ubicación actual'
                    });

                    Object.keys(grupos).forEach(function (grupo) {
                        agregarMarcadores(marcadores[grupo], grupo);
                    });

                    var groupFilters = document.createElement('div');
                    groupFilters.id = 'group-filters';
                    Object.keys(grupos).forEach(function (grupo) {
                        var checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = grupo.toLowerCase();
                        checkbox.className = 'group-filter';
                        checkbox.checked = true;
                        checkbox.addEventListener('change', function () {
                            toggleMarkers(grupos[grupo], this.checked);
                        });
                        var label = document.createElement('label');
                        label.htmlFor = grupo.toLowerCase();
                        label.textContent = grupo;
                        groupFilters.appendChild(checkbox);
                        groupFilters.appendChild(label);
                        groupFilters.appendChild(document.createElement('br'));
                    });
                    document.getElementById('map-container').appendChild(groupFilters);
                }, function () {
                    // Error handling when user denies location access
                    handleLocationError(true, infoWindow, map.getCenter());
                });
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, infoWindow, map.getCenter());
            }
        }

        function agregarMarcadores(marcadores, grupo) {
            marcadores.forEach(function (marcador) {
                var marker = new google.maps.Marker({
                    position: { lat: marcador.latitud, lng: marcador.longitud },
                    map: map,
                    title: marcador.sigla,
                    visible: true
                });

                var popupContent = `
                    <div style="max-width: 300px;">
                        <h3 style="margin: 0;">${marcador.sigla}</h3>
                        <p style="margin: 5px 0 0;">${marcador.nombre}</p>
                        <div class="horario-toggle" onclick="toggleHorario(this)">Horario</div>
                        <div class="horario-dropdown">
                            ${getHorarioDropdownContent(marcador.horario)}
                        </div>
                        <p style="margin: 0;"><strong>Dirección:</strong> ${marcador.direccion}</p>
                        <p style="margin: 0;"><strong>Origen:</strong> ${marcador.origen}</p>
                        ${getNuevaTablaContent(marcador)}
                        <img src="${marcador.foto}" alt="Foto del marcador" style="width: 100%; max-width: 200px; margin-top: 5px;">
                        ${getSocialTableContent(marcador)}
                        <button id="compartirBtn" onclick="compartir('${marcador.sigla}', ${marcador.latitud}, ${marcador.longitud})">Compartir</button>
                    </div>`;

                var infoWindow = new google.maps.InfoWindow({
                    content: popupContent
                });

                marker.addListener('click', function () {
                    infoWindow.open(map, marker);
                });

                grupos[grupo].push(marker);
            });
        }

        function getHorarioDropdownContent(horario) {
            var content = '';
            Object.keys(horario).forEach(dia => {
                content += `<button class="horario-button">${dia}: ${horario[dia]}</button>`;
            });
            return content;
        }

        function getSocialTableContent(marcador) {
            var content = '<table class="social-table"><tr>';
            if (marcador.facebook) {
                content += `<td><a href="${marcador.facebook}" target="_blank"><img src="facebook.png" alt="Facebook"></a></td>`;
            }
            if (marcador.whatsapp) {
                content += `<td><a href="${marcador.whatsapp}" target="_blank"><img src="whatsapp.png" alt="WhatsApp"></a></td>`;
            }
            if (marcador.tiktok) {
                content += `<td><a href="${marcador.tiktok}" target="_blank"><img src="tiktok.png" alt="TikTok"></a></td>`;
            }
            if (marcador.sitioWeb) {
                content += `<td><a href="${marcador.sitioWeb}" target="_blank"><img src="pagina.png" alt="Sitio Web"></a></td>`;
            }
            if (marcador.correo) {
                content += `<td><a href="${marcador.correo}" target="_blank"><img src="correo.jpg" alt="Correo"></a></td>`;
            }
            content += '</tr></table>';
            return content;
        }

        function getNuevaTablaContent(marcador) {
            var content = '<table class="nueva-tabla"><tr>';
            if (marcador.videopresentacion) {
                content += `<td><a href="${marcador.videopresentacion}" target="_blank"><img src="videopresentacion.png" alt="Videopresentacion"></a></td>`;
            }
            if (marcador.transporte) {
                content += `<td><a href="${marcador.transporte}" target="_blank"><img src="transporte.png" alt="Transporte"></a></td>`;
            }
            if (marcador.ecommerce) {
                content += `<td><a href="${marcador.ecommerce}" target="_blank"><img src="ecommerce.png" alt="Ecommerce"></a></td>`;
            }
            if (marcador.promocion) {
                content += `<td><a href="${marcador.promocion}" target="_blank"><img src="promocion.png" alt="Promoción"></a></td>`;
            }
            content += '</tr></table>';
            return content;
        }

        function toggleMarkers(markerArray, visible) {
            markerArray.forEach(marker => {
                marker.setVisible(visible);
            });
        }

        function toggleHorario(elemento) {
            var dropdown = elemento.nextElementSibling;
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function compartir(sigla, latitud, longitud) {
            // Construir el enlace
            var enlace = window.location.origin + window.location.pathname + '?marker=' + encodeURIComponent(sigla) + '&lat=' + encodeURIComponent(latitud) + '&lng=' + encodeURIComponent(longitud);

            // Crear el enlace de WhatsApp
            var enlaceWhatsApp = 'https://api.whatsapp.com/send?text=' + encodeURIComponent(enlace);

            // Abrir enlace en una nueva ventana o pestaña
            window.open(enlaceWhatsApp, '_blank');
        }

        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(browserHasGeolocation ?
                'Error: No se puede acceder a la ubicación del usuario' :
                'Error: Su navegador no admite la geolocalización.');
            infoWindow.open(map);
        }
    </script>
</head>

<body>
    <div id="map-container">
        <div id="map"></div>
        <button id="ubicacion-actual-btn" onclick="initMap()">Mi ubicación</button>
    </div>
</body>

</html>
